# JA4 Nginx Module

## Overview
This Nginx module implements **JA4**, **JA4H**, and **JA4one** fingerprinting standards for HTTP and TLS clients. It enables you to identify and fingerprint incoming requests based on their TLS handshake (Client Hello) and HTTP headers.

This module is designed for:
- **Security:** Detecting bots, scrapers, and malicious tools.
- **Access Control:** Blocking or allowing requests based on fingerprints.
- **Analytics:** Logging client types for traffic analysis.

## ⚠️ Custom Implementation Note
**Important:** This implementation uses **Full SHA256 Hashes (64 characters)** for the fingerprint components instead of the standard truncated 12-character hashes defined in the original JA4 spec.
- **Why?** To provide maximum collision resistance and complete cryptographic detail as per user requirements.
- **Result:** Fingerprints generated by this module will be significantly longer than standard JA4 strings.

## Features
- **JA4 (TLS)**: Fingerprints the TLS Client Hello (Version, Cipher Suites, Extensions, etc.).
- **JA4H (HTTP)**: Fingerprints HTTP headers (Method, Version, Cookie, Header Order).
- **JA4one (Composite)**: A combined fingerprint (`JA4_JA4H`) providing a holistic view of the client (TLS + HTTP).
- **Access Control Directives:** Native Nginx directives to block/allow traffic.
- **Variables:** Exposes fingerprints as Nginx variables for logging or Lua scripting.

## Installation

### Dependencies
- Nginx source code (tested with 1.27.3+)
- OpenSSL (development headers)

### Compilation
Configure Nginx with the `--add-module` flag pointing to this directory:

```bash
./configure --with-compat --add-module=/path/to/ja4-nginx-module --with-http_ssl_module
make
make install
```

## Configuration

### 1. Variables and Logging
The module exposes the following variables:
- `$http_ssl_ja4`: The TLS fingerprint.
- `$http_ssl_ja4h`: The HTTP fingerprint.
- `$http_ssl_ja4one`: The composite fingerprint.

Add them to your `log_format`:

```nginx
http {
    log_format ja4_log '$remote_addr - [$time_local] "$request" '
                       'JA4="$http_ssl_ja4" JA4H="$http_ssl_ja4h" JA4one="$http_ssl_ja4one"';

    access_log logs/ja4.log ja4_log;
}
```

### 2. Access Control
You can enforce rules in your `server` or `location` blocks.

**Directives:**
- `ja4_deny` / `ja4_allow`: Check against JA4 (TLS) fingerprint.
- `ja4h_deny` / `ja4h_allow`: Check against JA4H (HTTP) fingerprint.
- `ja4one_deny` / `ja4one_allow`: Check against JA4one composite fingerprint.

**Example:**

```nginx
server {
    listen 443 ssl;
    
    # Enable JA4 module (optional, enabled implicitly by directives/variables)
    ja4 on;

    # Block a specific curl client via JA4H
    ja4h_deny "ge11n03_fe444ad14866d725a8e22320d4ed56810819b0fae0efae0c09bedfdd";

    location / {
        # Allow specific bot via JA4one
        ja4one_allow "t13d3012_..._ge11n03_...";
        
        # Add headers for debugging
        add_header X-JA4-Fingerprint $http_ssl_ja4;
        add_header X-JA4one-Fingerprint $http_ssl_ja4one;
    }
}
```

## Fingerprint Formats (Custom)
Due to the full hash modification, the formats are:

- **JA4**: `t13d1516h2_<64-char-cipher-hash>_<64-char-extension-hash>`
- **JA4H**: `ge11n03_<64-char-header-hash>`
    - `ge`: GET Method
    - `11`: HTTP 1.1
    - `n`: No Cookie
    - `03`: 3 Headers
- **JA4one**: `[JA4]_[JA4H]` (Concatenated)

## Troubleshooting
- **Missing JA4?** Ensure you are connecting via **HTTPS**. Plain HTTP requests have no TLS handshake, so `$http_ssl_ja4` will be empty.
- **Short Codes?** If you see 12-char hashes, you are running the standard version. Recompile with the modified generic hash length if full hashes are required.

## License
MIT License.
